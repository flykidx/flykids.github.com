<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Thread dead loop -- auto variable</title>
    <link href="/2022/09/11/thread-dead-loop/"/>
    <url>/2022/09/11/thread-dead-loop/</url>
    
    <content type="html"><![CDATA[<p>When I was a student many years ago, the teacher described the difference between <strong>auto</strong> variables and <strong>volatile</strong> variables in detail. At that time, I thought it was just two keywords of C language, which were rarely used, so I didn’t pay much attention to them. With more and more work experience, I realized that these two ordinary guys have a lot of articles, and their existence means a contest between program <strong>performance</strong> and <strong>reliability</strong>.</p><h3 id="Problem-backgourd"><a href="#Problem-backgourd" class="headerlink" title="Problem backgourd"></a>Problem backgourd</h3><p>I am work at Tencent GVoice team since 2015. GVoice is voice-chat cross-platform SDK, serving 500+ games, 300 million active users. </p><p>Recently I found a strange problem, many users feedback that cannot open the microphone occasionally, <strong><font color="red">team members cannot hear his voice</font></strong>, but he can hear team members’ voice. </p><p>Allow me to introduce the steps to using voice-chat function: </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.Join team room; <br>2.Open microphone and speaker; <br>3.The captured voice data is forwarded to other team members through the RTC server. <br></code></pre></td></tr></table></figure><h3 id="Problem-analysis"><a href="#Problem-analysis" class="headerlink" title="Problem analysis"></a>Problem analysis</h3><p>Cannot-Hearing is a common problem in RTC-over-voice application. In 2019, I designed a Full-link QoS system to locate the cause of these probloms. The idea is as below:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.Tracing API Callings;<br>2.Tracing recording pipline(capture-&gt;resample-&gt;3A-&gt;mix-&gt;encode-&gt;pack-&gt;FEC-&gt;room-out);<br>3.Tracing voice data<span class="hljs-string">&#x27;s uplink, forwarding, and downlink;</span><br><span class="hljs-string">4.Tracing playing pipline(room-in-&gt;Dmx-&gt;deFEC-&gt;unpack-&gt;JB-&gt;decode-&gt;resample-&gt;mix-&gt;render).</span><br></code></pre></td></tr></table></figure><p>Through the Full-link QoS system, I located that <strong>the event of opening micphone was not processed by work thread, and the tick count of work thread is 0</strong>. so, was the work thread blocked or dead? This problom is set aside until opening LTO to optimize package size, aha, it was occurred again.</p><p>I dumped the thread call stack, found that the work thread run into loop code and cannot jump out. loop condition is a globle auto variable.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">SDK initialization call:<br>    int CEngine::<span class="hljs-function"><span class="hljs-title">StartEngine</span></span>()<br>    &#123;<br>    ...<br>        m_RecvProc.Start();<br>        m_thCapture.Start();<br>        m_thRender.Start();<br>        ...<br>        GetCtx()-&gt;bEngineStart = <span class="hljs-literal">true</span>;<br>        ...<br>    &#125;<br><br>Work thread call:<br>    int ThreadCapture::<span class="hljs-function"><span class="hljs-title">SysThreadProc</span></span>()<br>    &#123;<br>        ...<br>        //loop code to <span class="hljs-built_in">wait</span> the end of initialization<br>        <span class="hljs-keyword">while</span>(!GetCtx()-&gt;bEngineStart)<br>        &#123;<br>            SysSleep(5);<br>            <span class="hljs-built_in">continue</span>;<br>        &#125;<br>        //process cmd and task.<br>        ...<br>    &#125;<br></code></pre></td></tr></table></figure><p>We known that thread sleeping will causes cache invalid. CPU cache will be update after next thread tick when initialize complete. The bad news is <strong>SysSleep function is empty implementation under Android platform</strong>, causes the cpu that assiciated work thead to run at 100%.</p><p>So, Why does this problem occur at low frequencies, but it inevitably happens when LTO is enabled? usually, user thread sets bEngineStart to ture firstly, and then work thread jumps over the loop code. But, if user thread is blocked a short time(Enalbe LTO), work thread has start up firstly, and bEngineStart is still false, although user thread will set it to true later, but work thread has no chance to update it from memory.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">SDK initialization call:<br>    int CEngine::<span class="hljs-function"><span class="hljs-title">StartEngine</span></span>()<br>    &#123;<br>    ...<br>        m_RecvProc.Start();<br>        m_thCapture.Start();<br>        //!!!here blocked a short time<br>        m_thRender.Start();<br>        ...<br>        GetCtx()-&gt;bEngineStart = <span class="hljs-literal">true</span>;<br>        ...<br>    &#125;<br><br>Work thread call:<br>    int ThreadCapture::<span class="hljs-function"><span class="hljs-title">SysThreadProc</span></span>()<br>    &#123;<br>        ...<br>        //bEngineStart is always <span class="hljs-literal">false</span><br>        <span class="hljs-keyword">while</span>(!GetCtx()-&gt;bEngineStart)<br>        &#123;<br>            SysSleep(5);<br>            <span class="hljs-built_in">continue</span>;<br>        &#125;<br>        //process cmd and task.<br>        ...<br>    &#125;<br></code></pre></td></tr></table></figure><p>Therefore, user thread blocking and multiple threads switching will cause the above problem.</p><h3 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h3><p>SysSleep is an old version of thread sleeping implementation, new version Sleep function implementation is platform-wide, replace it with the new verion! </p><p>Of course, volatile variable can also solve this problem, for example:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#include &lt;windows.h&gt;</span><br><br>bool bRun = <span class="hljs-literal">false</span>;<br>DWORD WINAPI WorkThread(LPVOID param) &#123;<br>int nTick = 0;<br><span class="hljs-keyword">while</span> (!bRun) &#123;<br>++nTick;<br>&#125;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;tick %d\n&quot;</span>, nTick);<br><span class="hljs-built_in">return</span> 0L;<br>&#125;<br><br>int <span class="hljs-function"><span class="hljs-title">main</span></span>()<br>&#123;<br>HANDLE h = CreateThread(NULL, 0L, WorkThread, 0L, 0L, NULL);<br>    //wait a short time, <br>    //let work thread startup firstly<br>Sleep(10);<br><span class="hljs-keyword">if</span> (h != INVALID_HANDLE_VALUE) &#123;<br>bRun = <span class="hljs-literal">true</span>;<br>CloseHandle(h);<br>&#125;<br>system(<span class="hljs-string">&quot;pause&quot;</span>);<br>    <span class="hljs-built_in">return</span> 0;<br>&#125;<br></code></pre></td></tr></table></figure><p>The result of above program in <strong>debug</strong> mode:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">tick 11520226<br>Please press any key to <span class="hljs-built_in">continue</span>. . .<br></code></pre></td></tr></table></figure><p>The usual result in <strong>release</strong> mode:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">Please press any key to <span class="hljs-built_in">continue</span>. . .<br></code></pre></td></tr></table></figure><p>The rare result in <strong>release</strong> mode:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">tick 0<br>Please press any key to <span class="hljs-built_in">continue</span>. . .<br></code></pre></td></tr></table></figure><p>Assembly code in <strong>debug</strong> mode:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs bash">;virtual studio 2015 c++, debug ASM.<br>; 8    : DWORD WINAPI WorkThread(LPVOID param) &#123;<br>    push ebp<br>    mov ebp, esp<br>    push ecx<br>    mov DWORD PTR [ebp-4], -858993460 ; ccccccccH<br><br>; 9    : int nTick = 0;<br>    mov DWORD PTR _nTick$[ebp], 0<br><span class="hljs-variable">$LN2</span>@WorkThread:<br><br>; 10   : <span class="hljs-keyword">while</span> (!bRun) &#123;<br>    movzx eax, BYTE PTR ?bRun@@3_NA ; bRun<br>    <span class="hljs-built_in">test</span> eax, eax<br>    jne SHORT <span class="hljs-variable">$LN3</span>@WorkThread<br><br>; 11   : ++nTick;<br><br>    mov ecx, DWORD PTR _nTick$[ebp]<br>    add ecx, 1<br>    mov DWORD PTR _nTick$[ebp], ecx<br><br>; 12   : &#125;<br><br>    jmp SHORT <span class="hljs-variable">$LN2</span>@WorkThread<br><span class="hljs-variable">$LN3</span>@WorkThread:<br><br>; 13   : <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;tick %d\n&quot;</span>, nTick);<br>    mov edx, DWORD PTR _nTick$[ebp]<br>    push edx<br>    push OFFSET <span class="hljs-variable">$SG85407</span><br>    call _printf<br>    add esp, 8<br><br>; 14   : <span class="hljs-built_in">return</span> 0L;<br>    xor eax, eax<br>; 15   : &#125;<br></code></pre></td></tr></table></figure><p>Assembly code in <strong>release</strong> mode:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">;virtual studio 2015 c++, release ASM.<br>?WorkThread@@YGKPAX@Z PROC; WorkThread, COMDAT<br><br>; 9    : int nTick = 0;<br>; 10   : <span class="hljs-keyword">while</span> (!bRun) &#123;<br><br>cmpBYTE PTR ?bRun@@3_NA, 0; bRun<br>jneSHORT <span class="hljs-variable">$LN3</span>@WorkThread<br>npad7<br><span class="hljs-variable">$LL2</span>@WorkThread:<br>jmpSHORT <span class="hljs-variable">$LL2</span>@WorkThread<br><span class="hljs-variable">$LN3</span>@WorkThread:<br><br>; 11   : ++nTick;<br>; 12   : &#125;<br>; 13   : <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;tick %d\n&quot;</span>, nTick);<br><br>push0<br>pushOFFSET ??_C@_08EAGMJAIH@tick?5?<span class="hljs-variable">$CFd</span>?6?<span class="hljs-variable">$AA</span>@<br>call_printf<br>addesp, 8<br><br>; 14   : <span class="hljs-built_in">return</span> 0L;<br><br>xoreax, eax<br><br>; 15   : &#125;<br></code></pre></td></tr></table></figure><p>“++nTick;” code is ignored in release mode, and while loop gonna to be dead loop if bRun is false at fist, this is the compiler’s optimization behavior, the compiler considers that the bRun variable to be immutable. </p><p>Variable declared as <strong>volatile</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">volatile bool bRun = <span class="hljs-literal">false</span>;<br></code></pre></td></tr></table></figure><p>The result in <strong>release</strong> mode:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">tick 40011558<br>Please press any key to <span class="hljs-built_in">continue</span>. . .<br></code></pre></td></tr></table></figure><p>Assembly code of volatile version in <strong>release</strong> mode:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash">;virtual studio 2015 c++, release ASM.<br>?WorkThread@@YGKPAX@Z PROC; WorkThread, COMDAT<br><br>; 9    : int nTick = 0;<br><br>xoreax, eax<br><br>; 10   : <span class="hljs-keyword">while</span> (!bRun) &#123;<br><br>cmpBYTE PTR ?bRun@@3_NC, al; bRun<br>jneSHORT <span class="hljs-variable">$LN3</span>@WorkThread<br>npad6<br><span class="hljs-variable">$LL2</span>@WorkThread:<br><br>; 11   : ++nTick;<br><br>inceax<br>cmpBYTE PTR ?bRun@@3_NC, 0; bRun<br>jeSHORT <span class="hljs-variable">$LL2</span>@WorkThread<br><span class="hljs-variable">$LN3</span>@WorkThread:<br><br>; 12   : &#125;<br>; 13   : <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;tick %d\n&quot;</span>, nTick);<br><br>pusheax<br>pushOFFSET ??_C@_08EAGMJAIH@tick?5?<span class="hljs-variable">$CFd</span>?6?<span class="hljs-variable">$AA</span>@<br>call_printf<br>addesp, 8<br><br>; 14   : <span class="hljs-built_in">return</span> 0L;<br><br>xoreax, eax<br><br>; 15   : &#125;<br></code></pre></td></tr></table></figure><p>After variable is declared as volatile, optimization does not affect the program logic, everything is fine!</p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
